# CAS和AQS

## CAS

CAS全称CompareAndSwap，是一条 CPU 并发原语，意思就是比较然后替换，并且这个过程是原子的。在整个过程中有三个值，内存值，预期值，要修改的值，首先比较预期值和内存值是否相同，如果相同就表示没有别的线程来修改过值，那么就能放心更新，而如果不同，那就表示有其他线程来修改过了，就放弃更新操作，最后都统一返回更新前的内存值

CAS应用场景：
- 乐观锁
- 并发容器
- 原子类

在Java中使用Unsafe工具(JVM中提供硬件级别的原子操作)来直接获取到要修改的变量的内存地址，通过Atomic::cmpxchg方法实现不同平台上的原子比较和替换操作

CAS的缺点：
- ABA问题：虽然在比较时内存值和预期值相同，但其实内存值可能经历过了修改，只是最后又修改回了原先的值，因此过程中不能准确判断是否一定没有别的线程进行过操作(类似数据库中的幻读)
- 自旋时间过长：如果CAS失败，会一直尝试，如果CAS长时间不成功，会给CPU带来很大的开销
- CAS只能用来保证单个共享变量的原子操作，对于多个共享变量操作，CAS无法保证，需要使用锁

## AQS
